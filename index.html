<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paste-to-Share ‚Äî D√°n ·∫£nh l√† c√≥ link</title>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#f7f7f9; --card:#fff; --accent:#2563eb; --ok:#10b981; --err:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--fg); background:linear-gradient(180deg,#eef2ff,#f8fafc)}
    .container{max-width:880px;margin:40px auto;padding:24px}
    .card{background:var(--card); border-radius:18px; box-shadow:0 10px 25px rgba(0,0,0,.06); padding:24px}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
    .title{font-weight:800;font-size:22px}
    .hint{color:var(--muted)}
    .zone{border:2px dashed #c7d2fe; background:#eef2ff; border-radius:18px; padding:28px; text-align:center; transition: .2s ease;}
    .zone.highlight{border-color:var(--accent); background:#e0e7ff}
    .zone h2{margin:0 0 6px 0; font-size:20px}
    .zone p{margin:4px 0; color:var(--muted)}
    .controls{display:flex; gap:12px; justify-content:center; margin-top:12px}
    button,input[type="file"]::file-selector-button{cursor:pointer}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:700}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .ghost{background:#e2e8f0;color:#111}
    .row{display:grid;grid-template-columns:1fr;gap:14px;margin-top:18px}
    @media (min-width:720px){ .row{grid-template-columns: 1.2fr .8fr} }
    .preview{background:#fafafa;border:1px solid #eee;border-radius:14px;padding:12px;display:flex;align-items:center;justify-content:center;min-height:220px;position:relative}
    .preview.expired{border-color:#f87171;background:#fef2f2}
    .preview img{max-width:100%;max-height:420px;border-radius:10px}
    .status{border-radius:12px;border:1px dashed #e5e7eb;background:#fff;padding:14px}
    .status p{margin:0 0 10px}
    .urlbox{display:flex;gap:8px}
    .urlbox input{flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .ok{background:#ecfdf5;color:#065f46}
    .err{background:#fef2f2;color:#991b1b}
    .footer{margin-top:22px;color:var(--muted);font-size:13px}
    small code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
    .timer{background:#fff5cc;border:1px solid #fbbf24;border-radius:8px;padding:10px;margin:10px 0;text-align:center}
    .timer.expired{background:#fef2f2;border-color:#f87171;color:#dc2626}
    .timer-text{font-weight:600;margin:0}
    .warning{background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:8px;margin:8px 0;font-size:13px}
    .expired-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(239,68,68,0.1);border-radius:10px;display:none;align-items:center;justify-content:center;color:#dc2626;font-weight:600}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Paste‚Äëto‚ÄëShare</div>
          <div class="hint">Ch·ª•p m√†n h√¨nh ‚ûú <strong>Ctrl/‚åò + V</strong> v√†o khung d∆∞·ªõi ‚ûú nh·∫≠n ngay link public.</div>
        </div>
      </div>

      <div id="dropZone" class="zone" tabindex="0" aria-label="Khu v·ª±c d√°n ho·∫∑c k√©o th·∫£ ·∫£nh">
        <h2>D√°n ·∫£nh v√†o ƒë√¢y (Ctrl/‚åò + V)</h2>
        <p>Ho·∫∑c k√©o & th·∫£ t·ªáp ·∫£nh, ho·∫∑c ch·ªçn file th·ªß c√¥ng.</p>
        <div class="controls">
          <label class="btn ghost" for="fileInput">Ch·ªçn file‚Ä¶</label>
          <input id="fileInput" type="file" accept="image/*" hidden />
        </div>
      </div>

      <div class="row">
        <div class="preview" id="preview"><span class="hint">Ch∆∞a c√≥ ·∫£nh‚Ä¶</span></div>
        <div class="status" id="status">
          <p><span id="statusBadge" class="badge">Ch∆∞a t·∫£i l√™n</span></p>
          <div class="warning" id="warningBox" style="display:none;">
            ‚ö†Ô∏è Link s·∫Ω t·ª± ƒë·ªông h·∫øt h·∫°n sau <strong>5 ph√∫t</strong> v√† ·∫£nh s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!
          </div>
          <div class="timer" id="timerBox" style="display:none;">
            <p class="timer-text">‚è∞ Th·ªùi gian c√≤n l·∫°i: <span id="countdown">5:00</span></p>
          </div>
          <div class="urlbox">
            <input id="url" type="text" placeholder="Link s·∫Ω hi·ªán ·ªü ƒë√¢y" readonly />
            <button class="btn" id="copyBtn" disabled>Sao ch√©p</button>
          </div>
          <div class="footer">
            <small><code>Tip: B·∫°n c√≥ th·ªÉ d√°n nhi·ªÅu l·∫ßn; m·ªói l·∫ßn t·∫°o 1 link m·ªõi.<br>‚ö° Link ch·ªâ ho·∫°t ƒë·ªông trong 5 ph√∫t!</code></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =====================
    // C·∫§U H√åNH B·∫ÆT BU·ªòC:
    // 1) T·∫°o t√†i kho·∫£n Cloudinary (mi·ªÖn ph√≠)
    // 2) V√†o Settings ‚ûú Upload ‚ûú Add upload preset ‚ûú ch·ªçn Unsigned
    // 3) G√°n t√™n preset v√†o UPLOAD_PRESET, v√† cloud name v√†o CLOUD_NAME
    //    (Kh√¥ng c·∫ßn expose API secret ·ªü client.)
    // =====================
    const CLOUD_NAME = "dzl0gw7v3";      // ‚Üê thay b·∫±ng cloud name c·ªßa b·∫°n
    const UPLOAD_PRESET = "Picture"; // ‚Üê thay b·∫±ng upload preset UNSIGNED
    const FOLDER = "pastes"; // tu·ª≥ ch·ªçn: l∆∞u ·∫£nh v√†o folder n√†y tr√™n Cloudinary
    
    // Backend API endpoint - update this after deploying to Vercel
    const API_BASE_URL = window.location.hostname.includes('localhost') 
      ? 'http://localhost:3000' 
      : `https://${window.location.hostname}`;

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const statusBox = document.getElementById('status');
    const statusBadge = document.getElementById('statusBadge');
    const urlInput = document.getElementById('url');
    const copyBtn = document.getElementById('copyBtn');
    const warningBox = document.getElementById('warningBox');
    const timerBox = document.getElementById('timerBox');
    const countdown = document.getElementById('countdown');

    // Expiry management
    let expiryTimer = null;
    let countdownInterval = null;
    let currentImageData = null;
    const EXPIRE_MINUTES = 5;

    // UI helpers
    function setBadge(text, type){
      statusBadge.textContent = text;
      statusBadge.className = 'badge ' + (type === 'ok' ? 'ok' : type === 'err' ? 'err' : '');
    }
    function showPreview(file){
      const img = document.createElement('img');
      img.alt = '·∫¢nh xem tr∆∞·ªõc';
      img.src = URL.createObjectURL(file);
      preview.innerHTML = '';
      preview.appendChild(img);
    }

    // Expiry management functions
    function clearTimers(){
      if (expiryTimer) { clearTimeout(expiryTimer); expiryTimer = null; }
      if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
    }

    function formatTime(seconds){
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function startCountdown(uploadTime){
      const expireTime = uploadTime + (EXPIRE_MINUTES * 60 * 1000);
      
      // Show warning and timer
      warningBox.style.display = 'block';
      timerBox.style.display = 'block';
      
      // Update countdown every second
      countdownInterval = setInterval(()=>{
        const now = Date.now();
        const timeLeft = Math.max(0, Math.ceil((expireTime - now) / 1000));
        
        countdown.textContent = formatTime(timeLeft);
        
        if (timeLeft <= 0) {
          handleExpiry();
        } else if (timeLeft <= 60) {
          timerBox.classList.add('expired');
        }
      }, 1000);
      
      // Set main expiry timer
      const timeUntilExpiry = expireTime - Date.now();
      expiryTimer = setTimeout(handleExpiry, timeUntilExpiry);
    }

    function handleExpiry(){
      clearTimers();
      
      // Update UI
      setBadge('Link ƒë√£ h·∫øt h·∫°n', 'err');
      urlInput.value = '';
      copyBtn.disabled = true;
      warningBox.style.display = 'none';
      timerBox.style.display = 'none';
      timerBox.classList.remove('expired');
      
      // Attempt to delete image (note: this requires proper authentication)
      if (currentImageData && currentImageData.public_id) {
        attemptImageDeletion(currentImageData.public_id);
      }
      
      // Reset preview
      preview.innerHTML = '<span class="hint">Link ƒë√£ h·∫øt h·∫°n. H√£y t·∫£i ·∫£nh m·ªõi.</span>';
      preview.classList.add('expired');
      currentImageData = null;
      
      alert('‚ö†Ô∏è Link ƒë√£ h·∫øt h·∫°n sau 5 ph√∫t!\n·∫¢nh ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi server. H√£y t·∫£i l√™n ·∫£nh m·ªõi n·∫øu c·∫ßn.');
    }

    async function attemptImageDeletion(publicId){
      try {
        console.log(`üóëÔ∏è Attempting to delete image: ${publicId}`);
        
        // Extract just the filename part (remove folder prefix if present)
        const imageId = publicId.includes('/') ? publicId.split('/').pop() : publicId;
        
        const response = await fetch(`${API_BASE_URL}/api/delete-image`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            public_id: imageId,
            folder: FOLDER 
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log('‚úÖ Image deleted successfully:', result.message);
          return true;
        } else {
          console.warn('‚ö†Ô∏è Failed to delete image:', result.message);
          return false;
        }
        
      } catch (err) {
        console.error('‚ùå Error calling deletion API:', err);
        
        // If API call fails, still show user that link is expired
        // This ensures UX is not broken even if deletion fails
        console.log('üîÑ Link will still be expired locally regardless of deletion status');
        return false;
      }
    }

    // Upload to Cloudinary (unsigned)
    async function upload(file){
      if (!CLOUD_NAME || CLOUD_NAME.includes('YOUR_') || !UPLOAD_PRESET || UPLOAD_PRESET.includes('YOUR_')){
        setBadge('Thi·∫øu c·∫•u h√¨nh Cloudinary', 'err');
        throw new Error('Missing Cloudinary config');
      }
      setBadge('ƒêang t·∫£i l√™n‚Ä¶');

      const endpoint = `https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUD_NAME)}/image/upload`;
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);
      if (FOLDER) formData.append('folder', FOLDER);
      // T√πy ch·ªçn: public_id ri√™ng (ƒë·ªÉ t·∫°o URL ƒë·∫πp). M·∫∑c ƒë·ªãnh ƒë·ªÉ Cloudinary t·ª± sinh.
      // formData.append('public_id', crypto.randomUUID());

      const res = await fetch(endpoint, { method: 'POST', body: formData });
      if (!res.ok){
        const t = await res.text();
        throw new Error('Upload failed: ' + t);
      }
      const data = await res.json();
      
      // Store image data for future deletion
      currentImageData = {
        public_id: data.public_id,
        secure_url: data.secure_url,
        upload_time: Date.now()
      };
      
      return data.secure_url; // URL public (https)
    }

    // Handle pasted image
    async function handleItems(items){
      let file = null;
      for (const it of items){
        if (it.kind === 'file' && it.type.startsWith('image/')){
          file = it.getAsFile();
          break;
        }
      }
      if (!file){
        setBadge('Kh√¥ng th·∫•y ·∫£nh trong clipboard', 'err');
        return;
      }
      
      // Clear previous timers
      clearTimers();
      warningBox.style.display = 'none';
      timerBox.style.display = 'none';
      timerBox.classList.remove('expired');
      preview.classList.remove('expired');
      
      showPreview(file);
      copyBtn.disabled = true; urlInput.value = '';
      try{
        const link = await upload(file);
        urlInput.value = link;
        setBadge('Xong! Link ƒë√£ s·∫µn s√†ng', 'ok');
        copyBtn.disabled = false;
        
        // Start countdown timer
        if (currentImageData) {
          startCountdown(currentImageData.upload_time);
        }
      }catch(err){
        console.error(err);
        setBadge('L·ªói t·∫£i l√™n', 'err');
        alert(err.message);
      }
    }

    // Paste
    document.addEventListener('paste', (e)=>{
      if (e.clipboardData && e.clipboardData.items){
        handleItems(e.clipboardData.items);
      }
    });

    // Drag & Drop
    ;['dragenter','dragover'].forEach(evt=>{
      dropZone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.add('highlight'); });
    });
    ;['dragleave','drop'].forEach(evt=>{
      dropZone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('highlight'); });
    });
    dropZone.addEventListener('drop', (e)=>{
      const files = e.dataTransfer?.files;
      if (files && files.length){
        const file = files[0];
        if (!file.type.startsWith('image/')){ setBadge('Vui l√≤ng th·∫£ t·ªáp ·∫£nh', 'err'); return; }
        
        // Clear previous timers
        clearTimers();
        warningBox.style.display = 'none';
        timerBox.style.display = 'none';
        timerBox.classList.remove('expired');
        preview.classList.remove('expired');
        
        showPreview(file);
        copyBtn.disabled = true; urlInput.value = '';
        upload(file).then(link=>{
          urlInput.value = link; setBadge('Xong! Link ƒë√£ s·∫µn s√†ng', 'ok'); copyBtn.disabled = false;
          
          // Start countdown timer
          if (currentImageData) {
            startCountdown(currentImageData.upload_time);
          }
        }).catch(err=>{ console.error(err); setBadge('L·ªói t·∫£i l√™n', 'err'); alert(err.message); });
      }
    });

    // File picker
    fileInput.addEventListener('change', ()=>{
      const file = fileInput.files?.[0];
      if (!file) return;
      if (!file.type.startsWith('image/')){ setBadge('Vui l√≤ng ch·ªçn t·ªáp ·∫£nh', 'err'); return; }
      
      // Clear previous timers
      clearTimers();
      warningBox.style.display = 'none';
      timerBox.style.display = 'none';
      timerBox.classList.remove('expired');
      preview.classList.remove('expired');
      
      showPreview(file);
      copyBtn.disabled = true; urlInput.value = '';
      upload(file).then(link=>{
        urlInput.value = link; setBadge('Xong! Link ƒë√£ s·∫µn s√†ng', 'ok'); copyBtn.disabled = false;
        
        // Start countdown timer
        if (currentImageData) {
          startCountdown(currentImageData.upload_time);
        }
      }).catch(err=>{ console.error(err); setBadge('L·ªói t·∫£i l√™n', 'err'); alert(err.message); });
    });

    // Copy
    copyBtn.addEventListener('click', async ()=>{
      const link = urlInput.value.trim();
      if (!link) return;
      try{
        await navigator.clipboard.writeText(link);
        copyBtn.textContent = 'ƒê√£ sao ch√©p';
        setTimeout(()=>copyBtn.textContent='Sao ch√©p', 1200);
      }catch{
        urlInput.select();
        document.execCommand('copy');
      }
    });
  </script>
</body>
</html>
